<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: snippetCreation/snippetCreation.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: snippetCreation/snippetCreation.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* global hljs */

/**
 * Namespace for snippet creation functions
 * @namespace SnippetCreation
 */

// event listener to handle DOM Content load first upon which requests can be made
document.addEventListener('DOMContentLoaded', () => {
    // observes the selected date
    const snippetObserver = new class {
        /**
         * Update the snippets with the new selected date when globalDate is updated
         * 
         * @function update
         * @memberof SnippetCreation
         * @param {Date} date - new date to fetch snippets from and display  
         */
        update(date) {
            retrieve(date);
        }
    }();

    const sidebar = document.querySelector("side-calendar");
    sidebar.addObserver(snippetObserver);

    snippetObserver.update(sidebar.todayDate); // initial load date

    const code = document.getElementById('code-area')
    const language = document.getElementById('language-select')
    const snippetButton = document.querySelector('#snippet-form button');

    code.addEventListener('input', () => {
        validate(code, language, snippetButton);
    })

    language.addEventListener('change', () => {
        validate(code, language, snippetButton);
    })

    const snippetForm = document.getElementById('snippet-form');
    snippetForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const codeText = code.innerHTML;
        const languageChoice = language.value;
        snippetCompleted(codeText, languageChoice, sidebar.todayDate.toLocaleDateString('en-CA', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        }));

        // Alert message
        let text = document.getElementById("alert");
        text.textContent = "Snippet added!";
        if (text.classList.contains("fade-in")) { // if prev call in action: reset timer
            clearTimeout(ongoing);
        } else { // else, create message
            text.classList.add("fade-in");
        }
        
        // Set time out to three seconds to account for the second the element fades in
        ongoing = setTimeout(function () {
            text.classList.remove("fade-in");
            snippetButton.disabled = true;
        }, 2000); 

        document.getElementById("code-area").innerHTML = '';

        retrieve(sidebar.globalDate);
    });
});

/**
 * Create a POST request using fetch on the frontend after cleaning up new lines and single quotes
 * 
 * @function snippetCompleted
 * @memberof SnippetCreation
 * @param {string} code - the value of the code snippet the user types
 * @param {string} language - the language of the snippet the user selects
 * @param {string} date - the date the snippet was created
 * 
 * @example
 * // add snippet "console.log("Hello")" in javascript
 * snippetCompleted("console.log(\"Hello\")", "JavaScript");
 */
const snippetCompleted = (code, language, date) => {

    // percents and single quotes cause errors when URI encoding
    const noPercentCode = code.replace(/%/g, '%25').replaceAll(/'/g, "\\'");

    fetch(
        `/add-snippet?code=${encodeURIComponent(noPercentCode)}&amp;language=${language}&amp;date=${date}`,
        { method: 'POST' }
    );
    psuedoUpdateSnippetCount();
}

/**
 * Fetches all snippets and creates json file from them 
 * 
 * @function fetchSnippets
 * @memberof SnippetCreation
 * @param {string} date - the date string to fetch snippets from
 * @returns {JSON} - returns the snippets if successfully fetches or an empty array if failed
 * 
 * @example
 * // fetch snippets for June 7, 2024
 * fetchSnippets("2024-06-07");
 */
async function fetchSnippets(date) {
    try {
        const response = await fetch(`/fetch-snippets?date=${date}`);
        if (!response.ok) {
            throw new Error('Failed to fetch snippets');
        }
        return await response.json();
    } catch (error) {
        console.error('Error fetching snippets:', error);
        return [];
    }
}

/**
 * Displays the snippets in the top half of the 'Snippets' grey box
 * 
 * @function displaySnippets
 * @memberof SnippetCreation
 * @param {object[]} snippets - array of snippet objects with their code and language attributes 
 * 
 * @example
 * // display a snippet 
 * displaySnippets([{code: "console.log(\"Hello\")", code_language: "JavaScript"}, created_date: "2024-06-07T16:21:14.000Z"])
 */
function displaySnippets(snippets) {
    const container = document.getElementById('snippet-container');
    container.innerHTML = '';

    snippets.forEach(snippet => {
        // External conatiner for entire snippet
        const snippetBox = document.createElement('div');
        snippetBox.className = 'snippet-box';

        // Code Snippet
        const snippetText = document.createElement('button');
        snippetText.className = "snippet-button";

        // Language
        const snippetType = document.createElement('p');
        snippetType.className = 'snippet-type';
        snippetType.innerHTML = snippet.code_language;

        // Add pre code for snippet highlighting
        const pre = document.createElement('pre');
        const code = document.createElement('code');

        code.className = `language-${snippet.code_language.toLowerCase()}` // recognizes selected language

        // removes &lt; and > to prevent HTML injection
        code.innerHTML = decodeURIComponent(snippet.code).replaceAll('&lt;', '&amp;lt;').replaceAll('>', '&amp;gt;');
        
        pre.append(code);
        snippetText.appendChild(pre);

        // snippetText.textContent = snippet.code;
        snippetText.setAttribute("value", decodeURIComponent(snippet.code)) // replace string literal with new lines

        snippetText.addEventListener("click", () => { copy(snippetText) });

        // Add box to container
        snippetBox.appendChild(snippetType);
        snippetBox.appendChild(snippetText);
        container.appendChild(snippetBox);
    });
}

/**
 * Fetches snippets based on the date and displays them to the user
 * 
 * @function retrieve
 * @memberof SnippetCreation
 * @param {Date} date - the date to retrieve and display snippets from 
 * 
 * @example 
 * // retrieves and displays snippets for June 7, 2024
 * retrieve(new Date(2024, 5, 7));
 */
async function retrieve(date) {
    // prevents timezone issues with manual iso string conversion
    const snippets = await fetchSnippets(`${date.toLocaleDateString('en-CA', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    })}`);
    displaySnippets(snippets);
    hljs.highlightAll(); // highlights based on language
}

/**
 * @function psuedoUpdateSnippetCount
 * @memberof SnippetCreation
 * Adds 1 to the number of snippets created for the statistics element
 */
function psuedoUpdateSnippetCount() {
    const snippetStats = document.querySelector('snippets-statistics')
    const numSnippets = snippetStats.shadowRoot.getElementById('num-snippets')

    numSnippets.innerText = Number(numSnippets.innerText) + 1;
}

let ongoing;    // define a global variable to access timeout on separate function call
/**
 * Copies a copy snippet's text to the user's clipboard
 * 
 * @function copy
 * @memberof SnippetCreation
 * @param {HTMLElement} button - button that allows copying to user clipboard when clicked
 */
function copy(button) {
    // Copy the text to clipboard
    navigator.clipboard.writeText(button.value);

    // Alert message
    let text = document.getElementById("alert");
    text.textContent = "Copied to clipboard!";
    if (text.classList.contains("fade-in")) { clearTimeout(ongoing); }    // if prev call in action: reset timer
    else { text.classList.add("fade-in"); }                               // else, create message
    ongoing = setTimeout(function () {
        text.classList.remove("fade-in");
    }, 2000); // Set time out to three seconds to account for the second the element fades in
}

/**
 * Validates whether the user input is valid to submit or not
 * 
 * @function validate
 * @memberof SnippetCreation
 * @param {HTMLElement} code - editable code area element
 * @param {HTMLElement} language - language selector element
 * @param {HTMLElement} button - button that submits the form
 */
function validate(code, language, button) {
    if (code.innerText === '' || language.value === '') {
        button.disabled = true;
    } else {
        button.disabled = false;
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="DisplayTasks.html">DisplayTasks</a></li><li><a href="Server.html">Server</a></li><li><a href="SnippetCreation.html">SnippetCreation</a></li></ul><h3>Classes</h3><ul><li><a href="CompletedStatistics.html">CompletedStatistics</a></li><li><a href="CreatedSnippets.html">CreatedSnippets</a></li><li><a href="SideCalendar.html">SideCalendar</a></li></ul><h3>Global</h3><ul><li><a href="global.html#countStreak">countStreak</a></li><li><a href="global.html#fetchJsonStreaks">fetchJsonStreaks</a></li><li><a href="global.html#fetchNumCompleted">fetchNumCompleted</a></li><li><a href="global.html#fetchNumIncomplete">fetchNumIncomplete</a></li><li><a href="global.html#fetchNumIncompleteTasks">fetchNumIncompleteTasks</a></li><li><a href="global.html#fetchVisits">fetchVisits</a></li><li><a href="global.html#populateStreak">populateStreak</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Sun Jun 09 2024 17:19:56 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
